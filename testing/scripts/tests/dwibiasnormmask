mkdir -p ../tmp/dwibiasnormmask && mrconvert BIDS/sub-01/dwi/sub-01_dwi.nii.gz -fslgrad BIDS/sub-01/dwi/sub-01_dwi.bvec BIDS/sub-01/dwi/sub-01_dwi.bval tmp-sub-01_dwi.mif -force && dwibiasnormmask tmp-sub-01_dwi.mif ../tmp/dwibiasnormmask/default_out.mif ../tmp/dwibiasnormmask/default_mask.mif -output_bias ../tmp/dwibiasnormmask/default_bias.mif -output_scale ../tmp/dwibiasnormmask/default_scale.txt -output_tissuesum ../tmp/dwibiasnormmask/default_tissuesum.mif -force && testing_diff_image ../tmp/dwibiasnormmask/default_out.mif dwibiasnormmask/default_out.mif.gz -frac 1e-5 && testing_diff_image ../tmp/dwibiasnormmask/default_mask.mif dwibiasnormmask/default_mask.mif.gz && testing_diff_image ../tmp/dwibiasnormmask/default_bias.mif dwibiasnormmask/default_bias.mif.gz -frac 1e-5 && testing_diff_matrix ../tmp/dwibiasnormmask/default_scale.txt dwibiasnormmask/default_scale.txt -frac 1e-5 && testing_diff_image ../tmp/dwibiasnormmask/default_tissuesum.mif dwibiasnormmask/default_tissuesum.mif.gz -abs 1e-5
dwibiasnormmask tmp-sub-01_dwi.mif -max_iters 3 -dice 1.0 ../tmp/dwibiasnormmask/3iters_out.mif ../tmp/dwibiasnormmask/3iters_mask.mif -output_bias ../tmp/dwibiasnormmask/3iters_bias.mif -output_scale ../tmp/dwibiasnormmask/3iters_scale.txt -output_tissuesum ../tmp/dwibiasnormmask/3iters_tissuesum.mif -force && testing_diff_image ../tmp/dwibiasnormmask/3iters_out.mif dwibiasnormmask/3iters_out.mif.gz -frac 1e-5 && testing_diff_image ../tmp/dwibiasnormmask/3iters_mask.mif dwibiasnormmask/3iters_mask.mif.gz && testing_diff_image ../tmp/dwibiasnormmask/3iters_bias.mif dwibiasnormmask/3iters_bias.mif.gz -frac 1e-5 && testing_diff_matrix ../tmp/dwibiasnormmask/3iters_scale.txt dwibiasnormmask/3iters_scale.txt -frac 1e-5 && testing_diff_image ../tmp/dwibiasnormmask/3iters_tissuesum.mif dwibiasnormmask/3iters_tissuesum.mif.gz -abs 1e-5
dwibiasnormmask tmp-sub-01_dwi.mif -lmax 6,0,0 ../tmp/dwibiasnormmask/lmax600_out.mif ../tmp/dwibiasnormmask/lmax600_mask.mif -output_bias ../tmp/dwibiasnormmask/lmax600_bias.mif -output_scale ../tmp/dwibiasnormmask/lmax600_scale.txt -output_tissuesum ../tmp/dwibiasnormmask/lmax600_tissuesum.mif -force && testing_diff_image ../tmp/dwibiasnormmask/lmax600_out.mif dwibiasnormmask/lmax600_out.mif.gz -frac 1e-5 && testing_diff_image ../tmp/dwibiasnormmask/lmax600_mask.mif dwibiasnormmask/lmax600_mask.mif.gz && testing_diff_image ../tmp/dwibiasnormmask/lmax600_bias.mif dwibiasnormmask/lmax600_bias.mif.gz -frac 1e-5 && testing_diff_matrix ../tmp/dwibiasnormmask/lmax600_scale.txt dwibiasnormmask/lmax600_scale.txt -frac 1e-5 && testing_diff_image ../tmp/dwibiasnormmask/lmax600_tissuesum.mif dwibiasnormmask/lmax600_tissuesum.mif.gz -abs 1e-5
dwibiasnormmask tmp-sub-01_dwi.mif -reference 1.0 ../tmp/dwibiasnormmask/reference_out.mif ../tmp/dwibiasnormmask/reference_mask.mif -output_scale ../tmp/dwibiasnormmask/scale.txt -force && mrcalc ../tmp/dwibiasnormmask/reference_out.mif 1000.0 -mult - | testing_diff_image - dwibiasnormmask/default_out.mif.gz -frac 1e-5
mrcalc tmp-sub-01_dwi.mif 1000.0 -div tmp-sub-01_dwi_scaled.mif -force && dwibiasnormmask tmp-sub-01_dwi_scaled.mif ../tmp/dwibiasnormmask/scaled_out.mif ../tmp/dwibiasnormmask/scaled_mask.mif -output_scale ../tmp/dwibiasnormmask/scaled_scale.txt -force && testing_diff_image ../tmp/dwibiasnormmask/scaled_out.mif dwibiasnormmask/default_out.mif.gz -frac 1e-5
